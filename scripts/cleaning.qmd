---
title: "NBA Data Cleaning"
author: "Isaac"
format: html
---

## Purpose

This script cleans and organizes raw NBA games, city location, and city ranking
data to make three analysis datasets:

1. Player level game performance and rest stats  
2. Game level geographic information which are city, state, latitude, and longitude  
3. City level rankings from the Worldâ€™s Best Cities report  

All outputs are written as clean CSV files to the `output/` directory.

## Load packages

```{r}
library(tidyverse)
library(lubridate)
library(janitor)
library(here)
library(httr2)
library(jsonlite)
```

## Cleaning Process for Game Stats

```{r}


## raw game logs


tatum_raw  <- readRDS("data/imported_data/tatum_game_log_raw.rds")
murray_raw <- readRDS("data/imported_data/murray_game_log_raw.rds")
grimes_raw <- readRDS("data/imported_data/grimes_game_log_raw.rds")


## column names


tatum_raw  <- janitor::clean_names(tatum_raw)
murray_raw <- janitor::clean_names(murray_raw)
grimes_raw <- janitor::clean_names(grimes_raw)


## player identifiers


tatum_raw  <- tatum_raw  |> dplyr::mutate(player = "Jayson Tatum")
murray_raw <- murray_raw |> dplyr::mutate(player = "Dejounte Murray")
grimes_raw <- grimes_raw |> dplyr::mutate(player = "Quentin Grimes")


## combine players into dataset


games_raw <- dplyr::bind_rows(
  tatum_raw,
  murray_raw,
  grimes_raw
)

##  cleaned analysis dataset


games_clean <- games_raw |>

  # only rows where player had minutes
  dplyr::filter(!is.na(mp), mp != "") |>

  # select  columns
  dplyr::select(
    player,
    date,
    opp,
    mp,
    pts,
    home_away = x
  ) |>

  # clean and create variables
  dplyr::mutate(

    # parse
    date = as.Date(
      lubridate::parse_date_time(
        date,
        orders = c("mdy", "ymd", "b d, Y", "a, b d, Y")
      )
    ),

    # convert points
    pts = as.numeric(pts),

    # convert minutes
    mp = dplyr::if_else(
      stringr::str_detect(mp, ":"),
      as.numeric(lubridate::ms(mp)) / 60,
      as.numeric(mp)
    ),

    # points per minute
    ppm = pts / mp
  )

games_clean

games_final <- games_clean |>

  # remove NA games
  dplyr::filter(!is.na(mp), !is.na(date)) |>
  dplyr::arrange(player, date) |>
  dplyr::group_by(player) |>
  dplyr::mutate(
    days_rest = as.numeric(date - dplyr::lag(date)),
    back_to_back = days_rest == 1
  ) |>
  dplyr::ungroup()

games_final


##  save clean dataset

dir.create(here::here("data", "cleaned_data"), recursive = TRUE)

saveRDS(
  games_final,
  here::here("data", "cleaned_data", "games_final_clean.rds"))
```

## Cleaning Process for City Data from World's Best Cities
```{r}
wbc_raw <- readRDS(
  here("data", "imported_data", "worlds_best_cities_raw.rds")
)

wbc_clean <- wbc_raw |>
  select(
    ranking,
    city,
    state,
    population,
    highlighted_rank_1,
    highlighted_category_1,
    highlighted_category_2
  )

wbc_clean |> slice(1:5)

# save as csv
dir.create(here("data", "cleaned_data"), recursive = TRUE)
write_csv(
  wbc_clean,
  here("data", "cleaned_data", "worlds_best_cities_clean.csv")
)
```

## Create Game Location Dataset
```{r}
games_final <- readRDS(
  here("data", "cleaned_data", "games_final_clean.rds")
)

team_cities <- readRDS(
  here("data", "imported_data", "team_cities_raw.rds")
)

# join city and state
games_with_location <- games_final |>
  left_join(
    team_cities,
    by = c("opp" = "team")
  ) |>
  rename(
    state = region
  )

games_with_location |> slice(1:5)

cities_to_geocode <- games_with_location |>
  select(city, state) |>
  distinct()

cities_to_geocode |> slice(1:5)

# function to geocode city 
geocode_city <- function(city, state) {
  Sys.sleep(1)  
  req <- request("https://nominatim.openstreetmap.org/search") |>
    req_url_query(
      q = paste(city, state),
      format = "json",
      limit = 1
    ) |>
    req_user_agent("DSC210-NBA-Project")

  result <- tryCatch(
    {
      resp <- req |> req_perform()
      data <- resp |> resp_body_string() |> fromJSON()
      if (length(data) == 0) {
        tibble(lat = NA_real_, lon = NA_real_)
      } else {
        tibble(
          lat = as.numeric(data$lat[1]),
          lon = as.numeric(data$lon[1])
        )
      }
    },
    error = function(e) {
      tibble(lat = NA_real_, lon = NA_real_)
    }
  )
  result
}

# run API per city
geo_results <- cities_to_geocode |>
  rowwise() |>
  mutate(geo = list(geocode_city(city, state))) |>
  unnest(geo) |>
  ungroup()

geo_results |> slice(1:5)

## join lat/lon  to games_with_location

games_with_location_final <- games_with_location |>
  left_join(
    geo_results,
    by = c("city", "state")
  )

games_with_location_final |> slice(1:5)

# save csv
write_csv(
  games_with_location_final,
  here("data", "cleaned_data", "games_with_location_clean.csv")
)

```
```{r}
## final output csvs
dir.create(here("output"), recursive = TRUE)

write_csv(
  games_final,
  here("output", "games_final.csv")
)

write_csv(
  games_with_location_final,
  here("output", "games_with_location.csv")
)

write_csv(
  wbc_clean,
  here("output", "worlds_best_cities.csv")
)
```

